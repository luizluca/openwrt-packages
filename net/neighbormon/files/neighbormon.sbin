#!/bin/sh
# SPDX-License-Identifier: GPL-3.0-or-later
#
# Sends new discovered neighboors to stdout
#
ip monitor neigh | 
	awk '
		$1=="Deleted" {
			printf "DESTROY addr=%s dev=%s lladdr=%s\n", $2, DEV[$2], KNOWN[$2]
			delete KNOWN[$2]
			delete DEV[$2]
		}
		$(NF)=="REACHABLE" && KNOWN[$1] != $5 {
			KNOWN[$1]=$5
			DEV[$1]=$3
			printf "NEW addr=%s dev=%s lladdr=%s\n", $1,$3,$5
		} '

# Never exits normally
exit 1
